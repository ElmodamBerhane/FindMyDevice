<!DOCTYPE html>
<head>
    <title>{{.ProductName}}</title>
    <link rel="stylesheet" type="text/css" href="/static/style.css">
</head>
<body>
    <header>
    <h1>{{.ProductName}}</h1>
    <div id="login">
        <div id="persona-login"><div id="browserid"><img src="https://login.persona.org/i/sign_in_blue.png" id="signin"></div></div>
        <div id="persona-logout"><a href="/" id="signout">Logout</a></div>
    </div>
    </header>
    {{if not .UserId}}
            <div class="welcome">
                Please log in so that there is such wow and joy.
            </div>
    {{else}}
    <p>Welcome {{.UserId}}</p>
    {{if len .DeviceList }}
        <div class="caption">You have more than one device.
        Please select which device you'd like to work with.</div>
        <ul id="devices">
        {{range $device := .DeviceList}}
        <li><a href="{{urlquery ($device.ID)}}">{{html ($device.Name)}}</a></li>
        {{end}}
        </ul>
    {{else}}
    {{with $device := .Device}}
        <div class="device">
            <div class="name">{{html ($device.Name)}}</div>
            <div class="loggedin" data-state="{{$device.LoggedIn}}">Device is {{if not $device.LoggedIn }}<b>not</b>{{end}} accessible</div>
            <div class="lockable" data-state="{{$device.Lockable}}">Device {{if $device.Lockable }}has{{else}}does not have{{end}} a lock code</div>
            <div class="lastexchange" data-contact="{{$device.LastExchange}}">Last contact: {{$device.LastExchange}}</div>
            <ol class="positions">
                {{range $position := $device.PreviousPositions}}
                <li data-time="{{$position.Time}}" data-latitude="{{$position.Latitude}}" data-longitude="{{$position.Longitude}}" data-altitude="{{$position.Altitude}}"><a href="http://maps.google.com/maps?hl=en&ll={{$position.Latitude}},{{$position.Longitude}}">Position at {{$position.Time}}</a></li>
                {{end}}
            </ol>
            <!-- only display commands that the client specified it accepts
            -->
            <div class="commands">
                <div class="cmd"><button data-cmd="t" class="cmdb">Track Location</button><label>Duration (in seconds):<input name="d" placeholder="600"></label></div>
                <div class="cmd"><button data-cmd="r" class="cmdb">Ring</button><label>Duration (in seconds):<input name="d" placeholder="60"></label></div>
                <div class="cmd"><button data-cmd="l" class="cmdb">Lock</button><label>Lock Code:<input name="c" placeholder="0123"/></label><label>Lock Screen Message<input name="m" placeholder="Help! I'm lost!"/></label></div>
                <div class="cmd"><button data-cmd="e" class="cmdb">Erase</button></div>
            </div>
    {{end}}
    {{end}}
    {{end}}
    <footer>
         <i>Footery stuffs...</i>
         </footer>
         <script id='bidjs' src="https://login.persona.org/include.js" type="text/javascript"></script>
         <script type="text/javascript">

             function sendCommand(cmd) {
                 console.debug("Sending", cmd)
             }

window.addEventListener("load",
        function() {
        body = document.getElementsByTagName("body")[0];
        email="";
        if (body.dataset.user) {
            email = body.dataset.user;
        }
        navigator.id.watch({
                loggedInUser:email,
                onlogout: function(){},
                onlogin: function(assertion) {
                    body.style.cursor = "auto";
                    /* TODO: Send the assertion.
                       Refresh the page wth the current ID?
                    */
             /*
                    form = "<form method='POST' action='/' id='fs'>" +
                    "<input type='hidden' name='assertion' value='" +
                    assertion +
                    "'/><input type='hidden' name='audience' "+
                    "value='localhost'>" +
                    "</form>").appendTo('#browserid');
                    document.getElementById('browserid).innerHTML = form;
                    document.getElementById('fs').submit();
              */
                }
        })

        cmds = document.getElementsByClassName("cmd");
        cmdi = cmds.length;
        for (i=0;i<cmdi;i++) {
            b = cmds[i].getElementsByTagName("button");
            bi = b.length;
            for (j=0;j<bi;j++) {
                b[j].addEventListener("click",
                    function(t){
                    c = t.originalTarget.dataset.cmd;
                    console.debug(t,c);
                    args = t.originalTarget.parentElement.getElementsByTagName("input");
                    largs = args.length;
                    sargs = {};
                    for (i=0; i< largs; i++) {
                        arg=args[i];
                        sargs[arg.name] = arg.value;
                        }
                    sendCommand({c:sargs});
               })
           }
       }

        document.getElementById("signin").addEventListener("click",
                function(){
                document.getElementsByTagName("body")[0].style.cursor="wait";
                navigator.id.request();
                });
        document.getElementById("signout").addEventListener("click",
                function(){
                navigator.id.logout();
                });
    });
</script>
</body>
</html>
